"use strict";const{app:l,BrowserWindow:d,Menu:i,shell:p,ipcMain:r,dialog:n}=require("electron"),o=require("path"),u=require("electron-is-dev"),b=require("fs").promises;let s;function f(){s=new d({width:1200,height:800,minWidth:800,minHeight:600,webPreferences:{nodeIntegration:!1,contextIsolation:!0,enableRemoteModule:!1,preload:o.join(__dirname,"preload.js")},show:!1,titleBarStyle:"default"});const a=process.env.VITE_DEV_PORT||"5173",t=u?`http://localhost:${a}`:`file://${o.join(__dirname,"../dist/index.html")}`;s.loadURL(t),s.once("ready-to-show",()=>{s.show()}),s.on("closed",()=>{s=null}),s.webContents.setWindowOpenHandler(({url:e})=>(p.openExternal(e),{action:"deny"})),u?(s.webContents.openDevTools(),s.webContents.session.webRequest.onHeadersReceived((e,c)=>{c({responseHeaders:{...e.responseHeaders,"Content-Security-Policy":["default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: ws: wss:; script-src 'self' 'unsafe-eval' http://localhost:5173"]}})})):s.webContents.session.webRequest.onHeadersReceived((e,c)=>{c({responseHeaders:{...e.responseHeaders,"Content-Security-Policy":["default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self';"]}})})}l.whenReady().then(f);l.on("window-all-closed",()=>{process.platform!=="darwin"&&l.quit()});l.on("activate",()=>{d.getAllWindows().length===0&&f()});const h=()=>{const a=[{label:"文件",submenu:[{label:"新建文档",accelerator:"CmdOrCtrl+N",click:()=>{s.webContents.send("menu-new-document")}},{label:"导入数据",click:async()=>{const e=await n.showOpenDialog(s,{properties:["openFile"],filters:[{name:"JSON Files",extensions:["json"]}]});e.canceled||s.webContents.send("menu-import-data",e.filePaths[0])}},{label:"导出数据",click:async()=>{const e=await n.showSaveDialog(s,{filters:[{name:"JSON Files",extensions:["json"]}],defaultPath:`rect-words-backup-${new Date().toISOString().split("T")[0]}.json`});e.canceled||s.webContents.send("menu-export-data",e.filePath)}},{type:"separator"},{label:"退出",accelerator:process.platform==="darwin"?"Cmd+Q":"Ctrl+Q",click:()=>{l.quit()}}]},{label:"编辑",submenu:[{role:"undo",label:"撤销"},{role:"redo",label:"重做"},{type:"separator"},{role:"cut",label:"剪切"},{role:"copy",label:"复制"},{role:"paste",label:"粘贴"},{role:"selectall",label:"全选"}]},{label:"视图",submenu:[{role:"reload",label:"重新加载"},{role:"forceReload",label:"强制重新加载"},{role:"toggleDevTools",label:"开发者工具"},{type:"separator"},{role:"resetZoom",label:"实际大小"},{role:"zoomIn",label:"放大"},{role:"zoomOut",label:"缩小"},{type:"separator"},{role:"togglefullscreen",label:"全屏"}]},{label:"窗口",submenu:[{role:"minimize",label:"最小化"},{role:"close",label:"关闭"}]},{label:"帮助",submenu:[{label:"关于 Rect Words",click:()=>{n.showMessageBox(s,{type:"info",title:"关于 Rect Words",message:"Rect Words",detail:`一个智能的英语阅读学习工具
版本: 1.0.0

本地版本，无需网络连接即可使用。`})}}]}];process.platform==="darwin"&&(a.unshift({label:l.getName(),submenu:[{role:"about",label:"关于 "+l.getName()},{type:"separator"},{role:"services",label:"服务"},{type:"separator"},{role:"hide",label:"隐藏 "+l.getName()},{role:"hideothers",label:"隐藏其他"},{role:"unhide",label:"显示全部"},{type:"separator"},{role:"quit",label:"退出 "+l.getName()}]}),a[4].submenu=[{role:"close",label:"关闭"},{role:"minimize",label:"最小化"},{role:"zoom",label:"缩放"},{type:"separator"},{role:"front",label:"前置全部窗口"}]);const t=i.buildFromTemplate(a);i.setApplicationMenu(t)};l.whenReady().then(h);r.handle("get-app-version",()=>l.getVersion());r.handle("show-message-box",async(a,t)=>await n.showMessageBox(s,t));r.handle("select-folder",async(a,t={})=>{try{const e=await n.showOpenDialog(s,{properties:["openDirectory"],title:t.title||"选择文件夹",defaultPath:t.defaultPath||l.getPath("documents")});return!e.canceled&&e.filePaths.length>0?{success:!0,path:e.filePaths[0]}:{success:!1,cancelled:!0}}catch(e){return{success:!1,error:e.message}}});r.handle("check-folder-exists",async(a,t)=>{try{return{exists:!0,isDirectory:(await b.stat(t)).isDirectory()}}catch{return{exists:!1,isDirectory:!1}}});r.handle("create-folder",async(a,t)=>{try{return await b.mkdir(t,{recursive:!0}),{success:!0}}catch(e){return{success:!1,error:e.message}}});r.handle("get-default-data-paths",()=>{const a=l.getPath("userData"),t=l.getPath("documents"),e="RectWords";return{userData:a,documents:t,defaultDataFolder:o.join(t,e),defaultImportFolder:o.join(t,e,"Import"),defaultExportFolder:o.join(t,e,"Export"),defaultBackupFolder:o.join(t,e,"Backup")}});r.handle("open-folder",async(a,t)=>{try{return await p.openPath(t),{success:!0}}catch(e){return{success:!1,error:e.message}}});
